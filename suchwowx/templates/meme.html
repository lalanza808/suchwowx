
<!DOCTYPE html>
<html>
  {% include 'includes/head.html' %}
  <body>
  <section class="section">
    <div class="container">

      {% include 'includes/navbar.html' %}

      {% if meme %}
        {% if meme.meta_ipfs_hash %}
          {% set meta_url = config.IPFS_SERVER + "/ipfs/" + meme.meta_ipfs_hash %}
          {% set meme_url = config.IPFS_SERVER + "/ipfs/" + meme.meme_ipfs_hash %}
        {% else %}
          {% set meta_url = "" %}
          {% set meme_url = url_for('meta.uploaded_file', filename=meme.file_name, _external=True) %}
        {% endif %}

        <div id="screen">
          <div class="screen">
            {% if meme.file_name %}
            {% if meme.file_name.endswith('mp4') %}
              <video style="max-height: 60vh!important;max-width:100%;" {% if not request.MOBILE %}autoplay{% else %}controls{% endif %} muted loop>
                <source src="{{ meme_url }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            {% else %}
              <img src="{{ meme_url }}" id="memeImage" />
            {% endif %}
            {% endif %}
            <br/>
            <p>Title: <strong>{{ meme.title }}</strong></p>
            <p>Description: <strong>{{ meme.description }}</strong></p>
            <p>Poster Address: <a href="{{ url_for('user.show', handle=meme.user.handle) }}">{{ meme.user.handle }}</a></p>
            {% if meme.user.wownero_address %}
            <p>Wownero Address: <strong><span style="word-wrap: break-word">{{ meme.user.wownero_address }}</strong></p>
            {% endif %}
            {% if meme.meta_ipfs_hash %}
            <p>Meta IPFS: <a href="{{ meta_url }}" target=_self up-preload up-follow=".container">{{ meme.meta_ipfs_hash }}</a></p>
            {% endif %}
            {% if meme.meme_ipfs_hash %}
            <p>Meme IPFS: <a href="{{ meme_url }}" target=_self up-preload up-follow=".container">{{ meme.meme_ipfs_hash }}</a></p>
            {% endif %}
            <p>Meme ID: <code>{{ meme }}</code></p>
            <div id="profileModal" class="modal">
              <div class="modal-background"></div>
              <div class="modal-card">
                <header class="modal-card-head">
                  <p class="modal-card-title">Tip meme in WOW</p>
                  <button class="delete" aria-label="close" onclick="closeModal('profileModal')" id="closeModal"></button>
                </header>
                <section class="modal-card-body">
                  <p style="word-wrap: break-word;">Wownero Address: <span id="wowneroAddress">{{ meme.user.wownero_address | default('?') }}</span></p>
                </section>
                <footer class="modal-card-foot">
                </footer>
              </div>
            </div>
            {% if not meme.approved %}
            <br/>
            <div class="columns">
              <div class="column">
                <a class="button is-info is-12 column" href="{{ url_for('meme.approve', meme_id=meme.id, action='approve') }}">Approve</a>
              </div>
              <div class="column">
                <a class="button is-danger is-12 column" href="{{ url_for('meme.approve', meme_id=meme.id, action='deny') }}">Deny</a>
              </div>
            </div>
            {% else %}
            <br/>
              <div id="tipButtons" class="columns" style="display:none;">
                <!-- <div class="column">
                  <a class="button is-info is-12 column" onclick="tipAVAX()">Tip AVAX</a>
                </div>
                <div class="column">
                  <a class="button is-info is-12 column" onclick="tipWOWX()">Tip WOWX</a>
                </div> -->
                <div class="column">
                  <a class="button is-info is-12 column" onclick="tipWOW()">Tip</a>
                </div>
              </div>
              <div id="mintButton" class="columns" style="display:none;">
                <div class="column">
                  <a class="button is-danger is-12 column" onclick="mint()" id="mintButtonLoading">Mint</a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

    </div>
  </section>
  {% include 'includes/footer.html' %}
  {% if meme.approved %}
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', async () => {
      let minted = await isMinted('{{ meme.meta_ipfs_hash }}');
      if (minted) {
        document.getElementById('tipButtons').style.display = "flex";
      } else {
        document.getElementById('mintButton').style.display = "flex";
      }
      try {
        _walletAddress = w3.utils.toChecksumAddress('{{ meme.user.public_address }}');
        const userProfile = await contract.methods.userProfile(_walletAddress).call();
        console.log(userProfile)
        if (userProfile.wowneroAddress){document.getElementById('wowneroAddress').innerHTML = userProfile.wowneroAddress};
      } catch(e) {
        console.log(e);
      }
    });

    async function tipWOW() {
      document.getElementById('profileModal').classList.add('is-active');
      document.getElementById('closeModal').onclick = () => {
        document.getElementById('profileModal').classList.remove('is-active');
      }
    }

    async function tipAVAX() {
      const tokenId = await getTokenID('{{ meme.meta_ipfs_hash }}');
      const walletAddress = await getMetamaskAccount();
      const gasPrice = await w3.eth.getGasPrice();
      const gasLimit = await contract.methods.tipAVAX(tokenId).estimateGas({from: walletAddress}, function(err, gas){
        return gas;
      });

      try {
        notif(`Tipping meme "{{ meme.id | shorten_address }}" by "{{ meme.user.handle }} ({{ meme.user.public_address | shorten_address }})" to the Avalanche blockchain.`, 'info');
        let res = await contract.methods.tipAVAX(tokenId).send({
          from: walletAddress,
          value: 1,
          gasPrice: gasPrice,
          gas: gasLimit
        });
        console.log(res);
        window.location.href = "";
      } catch(e) {
        notif(e.message, 'warning');
      }
    }

    async function mint() {
      if (await isMinted('{{ meme.meta_ipfs_hash }}')) {
        notif('Already minted!', 'warning');
        return
      }
      document.getElementById('mintButtonLoading').classList.add('is-active');
      const walletAddress = await getMetamaskAccount();
      const gasPrice = await w3.eth.getGasPrice();
      const gasLimit = await contract.methods.mint("{{ meme.meta_ipfs_hash }}", "{{ meme.user.public_address }}").estimateGas({from: walletAddress}, function(err, gas){
        return gas;
      });
      try {
        notif(`Minting meme "{{ meme.id | shorten_address }}" by "{{ meme.user.handle }} ({{ meme.user.public_address | shorten_address }})" to the Avalanche blockchain.`, 'info');
        let res = await contract.methods.mint("{{ meme.meta_ipfs_hash }}", "{{ meme.user.public_address }}").send({
          from: walletAddress,
          value: 0,
          gasPrice: gasPrice,
          gas: gasLimit
        });
        console.log(res);
        document.getElementById('mintButtonLoading').classList.remove('is-active');
        window.location.href = "";
      } catch(e) {
        notif(e.message, 'warning');
      }
    }
  </script>
  {% endif %}
  </body>
</html>
